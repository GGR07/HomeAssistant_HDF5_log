#!/usr/bin/with-contenv bash
set -e

export PYTHONPATH="/usr/lib/hdf5_datalogger:${PYTHONPATH}"

read_interval() {
  if [ -f /data/options.json ]; then
    local val
    val=$(jq -r '.update_interval // 60' /data/options.json 2>/dev/null || echo 60)
    echo "$val" | grep -Eq '^[0-9]+$' && echo "$val" || echo 60
  else
    echo 60
  fi
}

while true; do
  python3 /usr/bin/logger.py || true
  sleep "$(read_interval)"
done
