#!/usr/bin/with-contenv bash

OUTPUT_FILE="/share/example_addon_output_nuovo.txt"
SUPERVISOR_TOKEN="$SUPERVISOR_TOKEN"
API_URL="http://supervisor/core/api"

# funzione per scrivere nel file
write_line() {
    echo "$1" >> "$OUTPUT_FILE"
}

# funzione per chiamare le API Home Assistant
ha_api() {
    endpoint="$1"

    curl -s -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
            -H "Content-Type: application/json" \
            "${API_URL}${endpoint}"
}

# Inizio generazione output
echo "===== HOME ASSISTANT STRUCTURE REPORT =====" > "$OUTPUT_FILE"
write_line "Generated at: $(date)"
write_line ""

##############################################
# 1. AREE
##############################################
AREAS=$(ha_api "/config/area_registry/list")

write_line "===== AREE ====="

echo "$AREAS" | jq -c '.[]' | while read -r area; do
    name=$(echo "$area" | jq -r '.name')
    id=$(echo "$area" | jq -r '.area_id')

    write_line "- ${name} (area_id: ${id})"
done

write_line ""
##############################################
# 2. DISPOSITIVI
##############################################
DEVICES=$(ha_api "/config/device_registry/list")

write_line "===== DISPOSITIVI ====="

echo "$DEVICES" | jq -c '.[]' | while read -r dev; do
    name=$(echo "$dev" | jq -r '.name_by_user // .name')
    id=$(echo "$dev" | jq -r '.id')
    area=$(echo "$dev" | jq -r '.area_id')

    write_line "- ${name} (device_id: ${id}, area: ${area})"
done

write_line ""
##############################################
# 3. ENTITÀ
##############################################
ENTITIES=$(ha_api "/config/entity_registry/list")

write_line "===== ENTITÀ ====="

echo "$ENTITIES" | jq -c '.[]' | while read -r ent; do
    entity_id=$(echo "$ent" | jq -r '.entity_id')
    device_id=$(echo "$ent" | jq -r '.device_id')
    area_id=$(echo "$ent" | jq -r '.area_id')

    write_line "- ${entity_id} (device_id: ${device_id}, area_id: ${area_id})"
done

write_line ""
##############################################
# 4. STATI
##############################################
STATES=$(ha_api "/states")

write_line "===== STATI ====="

echo "$STATES" | jq -c '.[]' | while read -r st; do
    entity_id=$(echo "$st" | jq -r '.entity_id')
    state=$(echo "$st" | jq -r '.state')
    write_line "- ${entity_id}: ${state}"
done

write_line ""
write_line "===== END ====="
